# 5，网关

## 入口网关

httpbin.yaml

```yaml
apiVersion: v1
kind: ServiceAccount
metadata:
  name: httpbin
---
apiVersion: v1
kind: Service
metadata:
  name: httpbin
  labels:
    app: httpbin
    service: httpbin
spec:
  ports:
  - name: http
    port: 8000
    targetPort: 80
  selector:
    app: httpbin
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: httpbin
spec:
  replicas: 1
  selector:
    matchLabels:
      app: httpbin
      version: v1
  template:
    metadata:
      labels:
        app: httpbin
        version: v1
    spec:
      serviceAccountName: httpbin
      containers:
      - image: docker.io/kennethreitz/httpbin
        imagePullPolicy: IfNotPresent
        name: httpbin
        ports:
        - containerPort: 80
```



```
kubectl -n bookinfo apply -f httpbin.yaml
```





配置入口网关

```yaml
apiVersion: networking.istio.io/v1alpha3
kind: Gateway
metadata:
  name: httpbin-gateway
spec:
  selector:
    istio: ingressgateway # use Istio default gateway implementation
  servers:
  - port:
      number: 80
      name: http
      protocol: HTTP
    hosts:
    - "*"
```



```
kubectl -n bookinfo apply -f httpbin_gw.yaml
```







配置 VistualService

```
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: httpbin
spec:
  hosts:
  - "*"
  gateways:
  - httpbin-gateway
  http:
  - match:
    - uri:
        prefix: /status
    - uri:
        prefix: /delay
    route:
    - destination:
        port:
          number: 8000
        host: httpbin
```



```
kubectl -n bookinfo apply -f httpbin_vs.yaml
```



```
kubectl get svc istio-ingressgateway  -n istio-system
```

![1683287785674](images/1683287785674.jpg)





httpbin 是一个 http 测试程序，我们可以通过使用 `/status/{状态码}` 获取对应的 http 请求状态。

例如：

![image-20230505200437890](images/image-20230505200437890.png)

![image-20230505200444999](images/image-20230505200444999.png)

如果我们不希望这个服务被外界访问到，我们可以先把 `/status` 删除。

```
kubectl apply -f - <<EOF
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: httpbin
spec:
  hosts:
  - "*"
  gateways:
  - httpbin-gateway
  http:
  - match:
    - uri:
        prefix: /delay
    route:
    - destination:
        port:
          number: 8000
        host: httpbin
EOF
```



此时你将无法访问 `status` 路径。

但是我们还可以访问 `/delay` 路径。

delay 路径用于延迟 http 请求响应使用，`/delay/{秒数}`.

例如 http://192.168.3.150:32309/delay/5 将在 5 秒后响应。



httpbin 还有很多路由接口，我们可以通过 VirtualService 配置放通哪些路径。

![image-20230505201156220](images/image-20230505201156220.png)



如果需要全部放通，可以使用：

```
kubectl apply -f - <<EOF
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: httpbin
spec:
  hosts:
  - "*"
  gateways:
  - httpbin-gateway
  http:
  - match:
    - uri:
        prefix: /
    route:
    - destination:
        port:
          number: 8000
        host: httpbin
        subset: v1
EOF
```



### 子版本

上一章中以及提到。



```yaml
kubectl -n bookinfo apply -f - <<EOF
apiVersion: networking.istio.io/v1alpha3
kind: DestinationRule
metadata:
  name: httpbin
spec:
  host: httpbin
  subsets:
  - name: v1
    labels:
      version: v1
EOF
```





```
kubectl -n bookinfo apply -f - <<EOF
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: httpbin
spec:
  hosts:
  - "*"
  gateways:
  - httpbin-gateway
  http:
  - match:
    - uri:
        prefix: /
    route:
    - destination:
        port:
          number: 8000
        host: httpbin
EOF
```



### 安全网关





## 出口网关